!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(t=t||self).SimpleDrawingBoard=i()}(this,function(){"use strict";function t(){this._events={}}function i(){this._items=[]}t.prototype={constructor:t,on:function(t,i){const e=this._events;t in e||(e[t]=[]),e[t].push(i)},off:function(t,i){const e=this._events;if(!(t in e))return;i||(e[t]=[]);const s=e[t].indexOf(i);s>=0&&e[t].splice(s,1)},trigger:function(t,i){const e=this._events;if(!(t in e))return;let s=0;const n=e[t].length;for(;s<n;s++){const n=e[t][s];n.handleEvent?n.handleEvent.call(this,i):n.call(this,i)}}},i.prototype={constructor:i,get:function(t){return this._items[t]},push:function(t){this._items.push(t)},pop:function(){return this._items.length>0?this._items.pop():null},shift:function(){return this._items.length>0?this._items.shift():null},size:function(){return this._items.length}};const e={isTouch:function(){return"ontouchstart"in window.document},isTransparent:function(t){if("transparent"===(t=t.replace(/\s/g,"")))return!0;if("0)"===t.split(",")[3])return!0;return!1},isDrawableEl:function(t){return-1!==["img","canvas","video"].indexOf(t.tagName.toLowerCase())},getAdjustedRect:function(t){const i=t.getBoundingClientRect();return{left:i.left+window.pageXOffset,top:i.top+window.pageYOffset}},getScale:function(t){const i=t.getBoundingClientRect();return{x:t.width/i.width,y:t.height/i.height}},rAF:(window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}).bind(window),cAF:(window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||function(t){window.clearTimeout(t)}).bind(window),Eve:t,Stack:i};var s={settings:{lineColor:"#aaa",lineSize:5,boardColor:"transparent",historyDepth:10}};function n(t,i){this._ensureEl(t),this.ev=new e.Eve,this.el=t,this.ctx=t.getContext("2d"),this._elRect={left:0,top:0},this._isDrawing=0,this._timer=null,this._coords={old:{x:0,y:0},oldMid:{x:0,y:0},current:{x:0,y:0}},this._settings={lineColor:null,lineSize:null,boardColor:null,historyDepth:null,isTransparent:null,isDrawMode:null},this._history={prev:new e.Stack,next:new e.Stack},this._initHistory(),this._initBoard(i)}return n.prototype={constructor:n,setLineSize:function(t){return this.ctx.lineWidth=0|t||1,this},setLineColor:function(t){return this.ctx.strokeStyle=t,this},fill:function(t){return this._saveHistory(),this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this},clear:function(){const t=this._settings;if(this._saveHistory(),t.isTransparent){const t=this.ctx.globalCompositeOperation;this.ctx.globalCompositeOperation="destination-out",this.fill(this._settings.boardColor),this.ctx.globalCompositeOperation=t}else this.fill(this._settings.boardColor);return this},toggleMode:function(){const t=this._settings;t.isDrawMode?(this.setLineColor(t.boardColor),t.isTransparent&&(this.ctx.globalCompositeOperation="destination-out"),t.isDrawMode=0):(this.setLineColor(t.lineColor),t.isTransparent&&(this.ctx.globalCompositeOperation="source-over"),t.isDrawMode=1);return this.ev.trigger("toggleMode",t.isDrawMode),this},getImg:function(){return this.ctx.canvas.toDataURL("image/png")},setImg:function(t,i,e){i=i||!1,(e=e||!1)||this._saveHistory();"string"==typeof t?this._setImgByImgSrc(t,i):this._setImgByDrawableEl(t,i);return this},undo:function(){this._restoreFromHistory(!1)},redo:function(){this._restoreFromHistory(!0)},dispose:function(){this._unbindEvents(),e.cAF(this._timer),this._timer=null,this._initHistory(),this.ev.trigger("dispose")},handleEvent:function(t){switch(t.preventDefault(),t.stopPropagation(),t.type){case"mousedown":case"touchstart":this._onInputDown(t);break;case"mousemove":case"touchmove":this._onInputMove(t);break;case"mouseup":case"mouseout":case"touchend":case"touchcancel":case"gesturestart":this._onInputUp()}},_ensureEl:function(t){if(!t||"object"!=typeof t||"canvas"!==t.tagName.toLowerCase())throw new Error("Pass canvas element as first argument.")},_initBoard:function(t){const i=this._settings=s.settings;if(t)for(const e in t)i[e]=t[e];e.isTransparent(i.boardColor)&&(i.boardColor="rgba(0,0,0,1)",i.isTransparent=1);i.isDrawMode=1,this.ctx.lineCap=this.ctx.lineJoin="round",this.setLineSize(i.lineSize),this.setLineColor(i.lineColor),this._bindEvents(),this._draw()},_bindEvents:function(){this._bindOrUnbindEvents(!0)},_unbindEvents:function(){this._bindOrUnbindEvents(!1)},_bindOrUnbindEvents:function(t){const i=e.isTouch()?["touchstart","touchmove","touchend","touchcancel","gesturestart"]:["mousedown","mousemove","mouseup","mouseout"],s=t?"addEventListener":"removeEventListener";for(let t=0,e=i.length;t<e;t++)this.el[s](i[t],this,!1)},_onInputDown:function(t){this._saveHistory(),this._isDrawing=1;const i=this._getInputCoords(t);this._coords.current=this._coords.old=i,this._coords.oldMid=this._getMidInputCoords(i)},_onInputMove:function(t){this._coords.current=this._getInputCoords(t)},_onInputUp:function(){this._isDrawing=0},_draw:function(){const t=this._coords.old.x===this._coords.current.x&&this._coords.old.y===this._coords.current.y;if(this._isDrawing&&!t){const t=this._getMidInputCoords(this._coords.current);this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y),this.ctx.quadraticCurveTo(this._coords.old.x,this._coords.old.y,this._coords.oldMid.x,this._coords.oldMid.y),this.ctx.stroke(),this._coords.old=this._coords.current,this._coords.oldMid=t,this.ev.trigger("draw",this._coords.current)}this._timer=e.rAF(this._draw.bind(this))},_getInputCoords:function(t){let i,s;e.isTouch()?(i=t.touches[0].pageX,s=t.touches[0].pageY):(i=t.pageX,s=t.pageY);return this._elRect=e.getAdjustedRect(this.el),this._elScale=e.getScale(this.el),{x:(i-this._elRect.left)*this._elScale.x,y:(s-this._elRect.top)*this._elScale.y}},_getMidInputCoords:function(t){return{x:this._coords.old.x+t.x>>1,y:this._coords.old.y+t.y>>1}},_setImgByImgSrc:function(t,i){const e=this.ctx,s=e.globalCompositeOperation,n=new Image;n.onload=function(){e.globalCompositeOperation="source-over",i||e.clearRect(0,0,e.canvas.width,e.canvas.height),e.drawImage(n,0,0,e.canvas.width,e.canvas.height),e.globalCompositeOperation=s},n.src=t},_setImgByDrawableEl:function(t,i){if(!e.isDrawableEl(t))return;const s=this.ctx,n=s.globalCompositeOperation;s.globalCompositeOperation="source-over",i||s.clearRect(0,0,s.canvas.width,s.canvas.height),s.drawImage(t,0,0,s.canvas.width,s.canvas.height),s.globalCompositeOperation=n},_initHistory:function(){this._history={prev:new e.Stack,next:new e.Stack}},_saveHistory:function(){const t=this._history,i=this.getImg(),s=t.prev.get(t.prev.size()-1);if(s&&i===s)return;for(;t.prev.size()>=this._settings.historyDepth;)t.prev.shift();t.prev.push(i),t.next=new e.Stack,this.ev.trigger("save",i)},_restoreFromHistory:function(t){const i=this._history;let e="next",s="prev";t&&(e="prev",s="next");const n=i[s].pop();if(null==n)return;const o=this.getImg(),r=i.next.get(i.next.size()-1);r&&r==o||i[e].push(o);this.setImg(n,!1,!0)}},n});
