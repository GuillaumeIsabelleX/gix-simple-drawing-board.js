!function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{var g;g="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,g.SimpleDrawingBoard=f()}}(function(){return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){module.exports={settings:{lineColor:"#aaa",lineSize:5,boardColor:"transparent",historyDepth:10}}},{}],2:[function(require,module,exports){"use strict";function SimpleDrawingBoard(el,options){this._ensureEl(el),this.ev=new Util.Eve,this.el=el,this.ctx=el.getContext("2d"),this._elRect=Util.getAdjustedRect(el),this._isDrawing=0,this._timer=null,this._coords={old:{x:0,y:0},oldMid:{x:0,y:0},current:{x:0,y:0}},this._settings={lineColor:null,lineSize:null,boardColor:null,historyDepth:null,isTransparent:null,isDrawMode:null},this._history={items:null,idx:null},this._initHistory(),this._initBoard(options)}function setLineSize(size){return this.ctx.lineWidth=0|size||1,this}function setLineColor(color){return this.ctx.strokeStyle=color,this}function fill(color){return this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.fillStyle=color,this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this._saveHistory(),this}function clear(){var settings=this._settings;if(settings.isTransparent){var oldGCO=this.ctx.globalCompositeOperation;this.ctx.globalCompositeOperation="destination-out",this.fill(this._settings.boardColor),this.ctx.globalCompositeOperation=oldGCO}else this.fill(this._settings.boardColor);return this._saveHistory(),this}function toggleMode(){var settings=this._settings;return settings.isDrawMode?(this.setLineColor(settings.boardColor),settings.isTransparent&&(this.ctx.globalCompositeOperation="destination-out"),settings.isDrawMode=0):(this.setLineColor(settings.lineColor),settings.isTransparent&&(this.ctx.globalCompositeOperation="source-over"),settings.isDrawMode=1),this.ev.trigger("toggleMode",settings.isDrawMode),this}function getImg(){return this.ctx.canvas.toDataURL("image/png")}function setImg(src,isOverlay){return isOverlay=isOverlay||!1,"string"==typeof src?this._setImgByImgSrc(src,isOverlay):this._setImgByDrawableEl(src,isOverlay),this._saveHistory(),this}function undo(){this._restoreFromHistory(!1)}function redo(){this._restoreFromHistory(!0)}function dispose(){this._unbindEvents(),Util.cAF(this._timer),this._timer=null,this._initHistory(),this.ev.trigger("dispose")}function _ensureEl(el){if(!el||"object"!=typeof el||"canvas"!==el.tagName.toLowerCase())throw new Error("Pass canvas element as first argument.")}function _initBoard(options){var settings=this._settings=Const.settings;if(options)for(var p in options)settings[p]=options[p];Util.isTransparent(settings.boardColor)&&(settings.boardColor="rgba(0,0,0,1)",settings.isTransparent=1),settings.isDrawMode=1,this.ctx.lineCap=this.ctx.lineJoin="round",this.setLineSize(settings.lineSize),this.setLineColor(settings.lineColor),this.clear(),this._bindEvents(),this._draw()}function _bindEvents(){this._bindOrUnbindEvents(!0)}function _unbindEvents(){this._bindOrUnbindEvents(!1)}function _bindOrUnbindEvents(bind){for(var events=Util.isTouch?["touchstart","touchmove","touchend","touchcancel","gesturestart"]:["mousedown","mousemove","mouseup","mouseout"],method=bind?"addEventListener":"removeEventListener",i=0,l=events.length;i<l;i++)this.el[method](events[i],this,!1)}function _draw(){var isSameCoords=this._coords.old.x===this._coords.current.x&&this._coords.old.y===this._coords.current.y;if(this._isDrawing&&!isSameCoords){var currentMid=this._getMidInputCoords(this._coords.current);this.ctx.beginPath(),this.ctx.moveTo(currentMid.x,currentMid.y),this.ctx.quadraticCurveTo(this._coords.old.x,this._coords.old.y,this._coords.oldMid.x,this._coords.oldMid.y),this.ctx.stroke(),this._coords.old=this._coords.current,this._coords.oldMid=currentMid,this.ev.trigger("draw",this._coords.current)}this._timer=Util.rAF(this._draw.bind(this))}function _onInputDown(ev){this._isDrawing=1;var coords=this._getInputCoords(ev);this._coords.current=this._coords.old=coords,this._coords.oldMid=this._getMidInputCoords(coords)}function _onInputMove(ev){this._coords.current=this._getInputCoords(ev)}function _onInputUp(){this._isDrawing=0,this._saveHistory()}function _handleEvent(ev){switch(ev.preventDefault(),ev.stopPropagation(),ev.type){case"mousedown":case"touchstart":this._onInputDown(ev);break;case"mousemove":case"touchmove":this._onInputMove(ev);break;case"mouseup":case"mouseout":case"touchend":case"touchcancel":case"gesturestart":this._onInputUp()}}function _getInputCoords(ev){var x,y;return Util.isTouch?(x=ev.touches[0].pageX,y=ev.touches[0].pageY):(x=ev.pageX,y=ev.pageY),{x:x-this._elRect.left,y:y-this._elRect.top}}function _getMidInputCoords(coords){return{x:this._coords.old.x+coords.x>>1,y:this._coords.old.y+coords.y>>1}}function _setImgByImgSrc(src,isOverlay){var ctx=this.ctx,oldGCO=ctx.globalCompositeOperation,img=new Image;img.onload=function(){ctx.globalCompositeOperation="source-over",isOverlay||ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height),ctx.drawImage(img,0,0,ctx.canvas.width,ctx.canvas.height),ctx.globalCompositeOperation=oldGCO},img.src=src}function _setImgByDrawableEl(el,isOverlay){if(Util.isDrawableEl(el)){var ctx=this.ctx,oldGCO=ctx.globalCompositeOperation;ctx.globalCompositeOperation="source-over",isOverlay||ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height),ctx.drawImage(el,0,0,ctx.canvas.width,ctx.canvas.height),ctx.globalCompositeOperation=oldGCO}}function _initHistory(){this._history={items:[],idx:0}}function _saveHistory(){var history=this._history,curImg=this.getImg(),lastImg=history.items[history.items.length-1];if(!lastImg||curImg!==lastImg){for(;history.items.length>=this._settings.historyDepth;)history.items.shift(),history.idx--;0!==history.idx&&history.idx<history.items.length?(history.items=history.items.slice(0,history.idx),history.idx++):history.idx=history.items.length+1,history.items.push(curImg),this.ev.trigger("save",curImg)}}function _restoreFromHistory(goForth){var history=this._history;if(!(goForth&&history.idx===history.items.length||!goForth&&1===history.idx)){var idx=goForth?history.idx+1:history.idx-1;history.items.length&&void 0!==history.items[idx-1]&&(history.idx=idx,this.setImg(history.items[idx-1]))}}var Util=require("./util"),Const=require("./const");SimpleDrawingBoard.prototype={constructor:SimpleDrawingBoard,setLineSize:setLineSize,setLineColor:setLineColor,fill:fill,clear:clear,toggleMode:toggleMode,getImg:getImg,setImg:setImg,undo:undo,redo:redo,dispose:dispose,handleEvent:_handleEvent,_ensureEl:_ensureEl,_initBoard:_initBoard,_bindEvents:_bindEvents,_unbindEvents:_unbindEvents,_bindOrUnbindEvents:_bindOrUnbindEvents,_onInputDown:_onInputDown,_onInputMove:_onInputMove,_onInputUp:_onInputUp,_draw:_draw,_getInputCoords:_getInputCoords,_getMidInputCoords:_getMidInputCoords,_setImgByImgSrc:_setImgByImgSrc,_setImgByDrawableEl:_setImgByDrawableEl,_initHistory:_initHistory,_saveHistory:_saveHistory,_restoreFromHistory:_restoreFromHistory},module.exports=SimpleDrawingBoard},{"./const":1,"./util":3}],3:[function(require,module,exports){(function(global){function isTouch(){return"ontouchstart"in global.document}function isTransparent(color){if(color=color.replace(/\s/g,""),"transparent"===color)return!0;var isRgbaOrHlsaTransparent="0)"===color.split(",")[3];return!!isRgbaOrHlsaTransparent}function isDrawableEl(el){var isDrawable=["img","canvas","video"].indexOf(el.tagName.toLowerCase())!==-1;return isDrawable}function getAdjustedRect(el){var elRect=el.getBoundingClientRect();return{left:elRect.left+global.scrollX,top:elRect.top+global.scrollY}}function rAF(){return(global.requestAnimationFrame||global.webkitRequestAnimationFrame||global.mozRequestAnimationFrame||function(callback){global.setTimeout(callback,1e3/60)}).bind(global)}function cAF(){return(global.cancelAnimationFrame||global.webkitCancelAnimationFrame||global.mozCancelAnimationFrame||function(callback){global.clearTimeout(callback)}).bind(global)}function Eve(){this._events={}}var Util={isTouch:isTouch(),isTransparent:isTransparent,isDrawableEl:isDrawableEl,getAdjustedRect:getAdjustedRect,rAF:rAF(),cAF:cAF(),Eve:Eve};Eve.prototype={constructor:Eve,on:function(evName,handler){var events=this._events;evName in events||(events[evName]=[]),events[evName].push(handler)},off:function(evName,handler){var events=this._events;if(evName in events){handler||(events[evName]=[]);var handlerIdx=events[evName].indexOf(handler);handlerIdx>=0&&events[evName].splice(handlerIdx,1)}},trigger:function(evName,evData){var handler,events=this._events;if(evName in events)for(var i=0,l=events[evName].length;i<l;i++)handler=events[evName][i],handler.handleEvent?handler.handleEvent.call(this,evData):handler.call(this,evData)}},module.exports=Util}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}]},{},[2])(2)});
